<!DOCTYPE html>
{% load static %}

<html>
<head>
  <meta charset="utf-8">
  <title>Criar Autor</title>
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <script>
    async function buscarAutor() {
      const nome = document.getElementById("id_nome").value;
      if (!nome) return;

      try {
        const resp = await fetch(`https://openlibrary.org/search/authors.json?q=${encodeURIComponent(nome)}`);
        const data = await resp.json();

        if (data.docs && data.docs.length > 0) {
          const autor = data.docs[0]; 
          const key = autor.key;

          const detResp = await fetch(`https://openlibrary.org${key}.json`);
          const det = await detResp.json();

          // Biografia
          if (det.bio) {
            if (typeof det.bio === "string") {
              document.getElementById("id_biografia").value = det.bio;
            } else if (det.bio.value) {
              document.getElementById("id_biografia").value = det.bio.value;
            }
          }

          // Nacionalidade
          let texto = (det.bio?.value || det.bio || "") + " " + (det.subjects || []).join(" ");
          let match = texto.match(/\b(Portuguese|Brazilian|French|English|Spanish|American|German|Italian)\b/i);
          if (match) {
            document.getElementById("id_nacionalidade").value = match[1];
          }

          // Foto
          if (det.photos && det.photos.length > 0) {
            const fotoId = det.photos[0];
            const fotoUrl = `https://covers.openlibrary.org/b/id/${fotoId}-M.jpg`;
            document.getElementById("id_foto_url").value = fotoUrl;
          }
        }
      } catch (err) {
        console.error("Erro ao buscar autor:", err);
      }
    }
  </script>
</head>
<body>
  <h1>Cadastrar Autor</h1>
  <form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <label for="id_foto_url">Foto:</label>
    <input type="url" id="id_foto_url" name="foto_url">
    <button type="button" onclick="buscarAutor()">Buscar dados na OpenLibrary</button>
    <button type="submit">Salvar</button>
  </form>

  <br>
  <a href="{% url 'listar_autores' %}">Voltar Ã  lista</a>
</body>
</html>